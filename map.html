<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi â€“ BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#020617;
  color:white
}
header{
  height:60px;
  display:flex;
  align-items:center;
  padding:0 20px;
  background:linear-gradient(90deg,#0f172a,#020617);
  font-size:22px;
  font-weight:bold
}

/* SIDEBAR */
#sidebar{
  position:fixed;
  top:60px;
  left:0;
  width:220px;
  height:calc(100vh - 60px);
  background:#020617;
  padding:12px;
  box-sizing:border-box;
  overflow-y:auto;
}
button{
  width:100%;
  margin:4px 0;
  padding:8px;
  border:none;
  border-radius:4px;
  color:white;
  cursor:pointer
}
.blue{background:#2563eb}
.gray{background:#334155}
.red{background:#dc2626}

/* Submenu */
.submenu{
  display:none;
  margin-left:12px;
}
.submenu button{
  font-size:13px;
  background:#1e293b;
}

/* MAIN */
#main{
  margin-left:220px;
  height:calc(100vh - 60px);
  display:flex;
  flex-direction:column
}
#map{flex:1}

/* TABLE */
#toggle{
  text-align:center;
  padding:6px;
  background:#020617;
  border-top:1px solid #334155;
  cursor:pointer
}
#node-section{
  max-height:260px;
  overflow:auto;
  background:#1e293b;
  transition:.3s
}
#node-section.hidden{max-height:0}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px
}
th,td{
  padding:6px;
  border-bottom:1px solid #334155;
  text-align:left
}
th{background:#020617}
.up{color:#22c55e}
.down{color:#ef4444}

/* NODE BLINK */
@keyframes blink{
  0%{opacity:1}
  50%{opacity:.35}
  100%{opacity:1}
}
.node-blink{animation:blink 1s infinite}
.node-blink.fast{animation:blink .4s infinite}

/* RULER LABEL */
.ruler-label{
  background:#020617;
  color:#facc15;
  border:1px solid #facc15;
  padding:4px 8px;
  border-radius:4px;
  font-size:12px;
}
  #coords{
  background:#020617;
  border-top:1px solid #334155;
  padding:6px 12px;
  font-size:13px;
  color:#22c55e;
  font-family:monospace;
}
</style>
</head>

<body>
<header>Topology â€“ BWA WiBAS</header>

<!-- SIDEBAR -->
<div id="sidebar">
  <h4>Area</h4>
  <!-- all area buttons -->
  <button class="blue" onclick="showAll()">All</button>

  <!-- Region buttons -->
  <button class="gray" onclick="toggleSubmenu('CRO')">CRO â–¼</button>
  <div class="submenu" id="submenu-CRO">
    <button onclick="filterRegion('CJDA')">CJDA</button>
    <button onclick="filterRegion('KAA')">KAA</button>
    <button onclick="filterRegion('WJA')">WJA</button>
  </div>

  <button class="gray" onclick="toggleSubmenu('ERO')">ERO â–¼</button>
  <div class="submenu" id="submenu-ERO">
    <button onclick="filterRegion('BNA')">BNA</button>
    <button onclick="filterRegion('EJA')">EJA</button>
    <button onclick="filterRegion('MAPUA')">MAPUA</button>
  </div>

  <button class="gray" onclick="toggleSubmenu('GJO')">GJO â–¼</button>
  <div class="submenu" id="submenu-GJO">
    <button onclick="filterRegion('BWA')">BWA</button>
    <button onclick="filterRegion('BDA')">BDA</button>
    <button onclick="filterRegion('CDA')">CDA</button>
    <button onclick="filterRegion('NEA')">NEA</button>
    <button onclick="filterRegion('SAST')">SAST</button>
    <button onclick="filterRegion('SEOA')">SEOA</button>
  </div>

  <button class="gray" onclick="toggleSubmenu('WRO')">WRO â–¼</button>
  <div class="submenu" id="submenu-WRO">
    <button onclick="filterRegion('CSA')">CSA</button>
    <button onclick="filterRegion('NSA')">NSA</button>
    <button onclick="filterRegion('SSA')">SSA</button>
  </div>

  
  <hr style="border:1px solid #334155">

  <h4>Ruler</h4>
  <button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
  <button class="red" onclick="resetRuler()">Reset Ruler</button>

  <hr style="border:1px solid #334155">

  <button class="gray" onclick="toggleCoverage()">Toggle Coverage</button>

<hr style="border:1px solid #334155">

<h4>Topology Editor</h4>
<button class="blue" onclick="activateAddNode()">Tambah Node</button>
<button class="blue" onclick="activateAddUser()">Tambah User</button>

<hr style="border:1px solid #334155">

<button class="blue" onclick="backToMenu()">Kembali ke Menu</button>
</div>

<!-- MAIN -->
<div id="main">
<div id="map"></div>
<div id="coords">Lat: - | Lng: -</div>
<div id="toggle" onclick="toggleTable()">â–² / â–¼</div>
  <div id="node-section">
    <table>
      <thead>
        <tr><th>Node / Kota</th><th>Area</th><th>Status</th></tr>
      </thead>
      <tbody id="node-table"></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= SUBMENU ================= */
function toggleSubmenu(region){
  const el=document.getElementById('submenu-'+region);
  el.style.display = el.style.display==='block' ? 'none':'block';
}

/* ================= MAP ================= */
const map = L.map('map').setView([-6.9,110.5],5);

/* ===== GOOGLE SATELLITE ONLY ===== */
const googleSat = L.tileLayer(
  'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
  {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
  }
);

/* ===== GOOGLE HYBRID (Satellite + Jalan) ===== */
const googleHybrid = L.tileLayer(
  'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
  {
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3']
  }
);

/* ===== OSM (Cadangan) ===== */
const osm = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
);

/* Default Map */
googleHybrid.addTo(map);

/* Layer Control */
L.control.layers(
  {
    "Hybrid (Satellite + Jalan)": googleHybrid,
    "Satellite Only": googleSat,
    "OSM Map": osm
  },
  null,
  { position: 'topright' }
).addTo(map);
/* ================= RULER (FINAL BENAR) ================= */
let rulerActive=false;
let rulerPoints=[]; let rulerLine=null; let rulerMarkers=[]; let rulerLabel=null;

function activateRuler(){ resetRuler(); rulerActive=true; map.getContainer().style.cursor='crosshair'; }
function resetRuler(){ rulerActive=false; rulerPoints=[]; if(rulerLine) map.removeLayer(rulerLine); rulerMarkers.forEach(m=>map.removeLayer(m)); if(rulerLabel) map.removeLayer(rulerLabel); rulerLine=null; rulerMarkers=[]; rulerLabel=null; map.getContainer().style.cursor=''; }
function calculateAzimuth(p1,p2){ const lat1=p1.lat*Math.PI/180; const lat2=p2.lat*Math.PI/180; const dLon=(p2.lng-p1.lng)*Math.PI/180; const y=Math.sin(dLon)*Math.cos(lat2); const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon); return (Math.atan2(y,x)*180/Math.PI+360)%360; }
function addRulerPoint(latlng){
  if(rulerPoints.length>=2) return;
  rulerPoints.push(latlng);
  const m=L.marker(latlng,{draggable:true,icon:L.divIcon({className:'',iconSize:[12,12],html:'<div style="width:12px;height:12px;border-radius:50%;background:#facc15"></div>'})}).addTo(map);
  m.on('drag',()=>{ rulerPoints[rulerMarkers.indexOf(m)]=m.getLatLng(); rulerLine.setLatLngs(rulerPoints); const d=map.distance(rulerPoints[0],rulerPoints[1])/1000; const az=calculateAzimuth(rulerPoints[0],rulerPoints[1]); const mid=[(rulerPoints[0].lat+rulerPoints[1].lat)/2,(rulerPoints[0].lng+rulerPoints[1].lng)/2]; rulerLabel.setLatLng(mid).setContent(`<b>${d.toFixed(2)} km<br>Azimuth: ${az.toFixed(1)}Â°</b>`); });
  rulerMarkers.push(m);
  if(rulerPoints.length===2){
    rulerLine=L.polyline(rulerPoints,{color:'#facc15',weight:3}).addTo(map);
    const d=map.distance(rulerPoints[0],rulerPoints[1])/1000;
    const az=calculateAzimuth(rulerPoints[0],rulerPoints[1]);
    const mid=[(rulerPoints[0].lat+rulerPoints[1].lat)/2,(rulerPoints[0].lng+rulerPoints[1].lng)/2];
    rulerLabel=L.tooltip({permanent:true,direction:'center',className:'ruler-label'}).setLatLng(mid).setContent(`<b>${d.toFixed(2)} km<br>Azimuth: ${az.toFixed(1)}Â°</b>`).addTo(map);
    rulerActive=false; map.getContainer().style.cursor='';
  }
}
map.on('click',e=>{if(rulerActive) addRulerPoint(e.latlng);});

/* ================= NODE ICON ================= */
function icon(colors,fast=false){ return L.divIcon({className:`node-blink ${fast?'fast':''}`,iconSize:[36,36],iconAnchor:[18,18],html:`<svg width="36" height="36" viewBox="0 0 100 100"><path d="M50 50 L50 0 A50 50 0 0 1 100 50 Z" fill="${colors[0]}"/><path d="M50 50 L100 50 A50 50 0 0 1 50 100 Z" fill="${colors[1]}"/><path d="M50 50 L50 100 A50 50 0 0 1 0 50 Z" fill="${colors[2]}"/><path d="M50 50 L0 50 A50 50 0 0 1 50 0 Z" fill="${colors[3]}"/><circle cx="50" cy="50" r="9" fill="#020617" stroke="white" stroke-width="2"/></svg>`});}

/* ================= SECTOR ================= */
function createSector(center, radius, startAz, endAz, opt){
  const pts = [center];

  for(let az = startAz; az <= endAz; az += 2){
    const rad = az * Math.PI / 180;

    // azimuth: 0 = north
    const lat = center.lat + (radius * Math.cos(rad)) / 111320;
    const lng = center.lng + (radius * Math.sin(rad)) /
      (111320 * Math.cos(center.lat * Math.PI / 180));

    pts.push([lat, lng]);
  }

  pts.push(center);
  return L.polygon(pts, opt);
}


/* ================= NODE DATA ================= */
const nodes=[
 {name:'SLOSRH',region:'CJDA',lat:-7.563986,lng:110.819334,status:'UP',
 sectorDefs:[{start:0,end:90},{start:90,end:180},{start:180,end:270}]},
 {name:'BLPRAM',region:'KAA',lat:-1.247917,lng:116.838194,status:'DOWN',
 sectorDefs:[{start:45,end:135}]},
 {name:'BDGBBPB',region:'WJA',lat:-6.836141,lng:107.48698,status:'UP',
 sectorDefs:[{start:165,end:255}]},
 {name:'BDGCLY',region:'WJA',lat:-6.940522,lng:107.75132,status:'DOWN',
 sectorDefs:[{start:135,end:225}]},
 {name:'DPSIKT',region:'BNA',lat:-8.735832,lng:115.178706,status:'UP',
 sectorDefs:[{start:175,end:265},{start:350,end:80}]},
 {name:'GRSTGP',region:'EJA',lat:-7.150680,lng:112.646615,status:'UP',
 sectorDefs:[{start:135,end:225},{start:315,end:45}]},
 {name:'MJKGTO',region:'EJA',lat:-7.484068,lng:112.439306,status:'UP',
 sectorDefs:[{start:70,end:160},{start:250,end:340},{start:340,end:70}]},
 {name:'SDJCNG',region:'EJA',lat:-7.407205,lng:112.618979,status:'UP'},
 {name:'SDJSNY',region:'EJA',lat:-7.348534,lng:112.767766,status:'UP',
 sectorDefs:[{start:90,end:180},{start:180,end:270},{start:270,end:360}]},
 {name:'SDJWGP',region:'EJA',lat:-7.376449,lng:112.694152,status:'UP'},
 {name:'SBYGPN',region:'EJA',lat:-7.319528,lng:112.731423,status:'UP'},
 {name:'SBYILT',region:'EJA',lat:-7.272927,lng:112.742805,status:'UP',
 sectorDefs:[{start:180,end:270}]},
 {name:'SBYKYN',region:'EJA',lat:-7.271313,lng:112.744322,status:'UP',
 sectorDefs:[{start:0,end:90},{start:270,end:360}]},
 {name:'SBYPGT',region:'EJA',lat:-7.234389,lng:112.773033,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315}]},
 {name:'SBYRWJ',region:'EJA',lat:-7.231425,lng:112.729394,status:'UP'},
 {name:'SBYSNR',region:'EJA',lat:-7.275505,lng:112.684784,status:'UP'},
 {name:'SBYSPO',region:'EJA',lat:-7.289116,lng:112.678018,status:'UP',
 sectorDefs:[{start:270,end:360}]},
 {name:'MKSHAM',region:'MAPUA',lat:-5.1480556,lng:119.41046667,status:'UP',
 sectorDefs:[{start:20,end:110},{start:110,end:200},{start:245,end:335}]},
 {name:'MKSHBR',region:'MAPUA',lat:-5.10165,lng:119.511,status:'DOWN',
 sectorDefs:[{start:193,end:283}]},
 {name:'CLGIM3',region:'BWA',lat:-6.119008,lng:106.338023,status:'UP',
 sectorDefs:[{start:315,end:45}]},
 {name:'JKTCIG',region:'BWA',lat:-6.130824,lng:106.735322,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315}]},
 {name:'JKTKD2',region:'BWA',lat:-6.188801,lng:106.767965,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'SRGSTR',region:'BWA',lat:-6.120406,lng:106.157626,status:'UP',
 sectorDefs:[{start:45,end:135},{start:315,end:45}]},
 {name:'TGRBLD',region:'BWA',lat:-6.138183,lng:106.659738,status:'DOWN'},
 {name:'TGRCIL',region:'BWA',lat:-6.225322525,lng:106.708201,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315}]},
 {name:'TGRCUR',region:'BWA',lat:-6.217032745,lng:106.5673415,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'TGRMTH',region:'BWA',lat:-6.229061217,lng:106.6097212,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315}]},
 {name:'TGRMUB',region:'BWA',lat:-6.14180778,lng:106.68481951,status:'UP',
 sectorDefs:[{start:45,end:135},{start:315,end:45}]},
 {name:'TGRSTS',region:'BWA',lat:-6.221908,lng:106.632164,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTBRI',region:'BDA',lat:-6.216943,lng:106.813893,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTIMP',region:'BDA',lat:-6.210278,lng:106.831211,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTHST',region:'CDA',lat:-6.192211,lng:106.864625,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTMNC',region:'CDA',lat:-6.184064,lng:106.831195,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTASK',region:'NEA',lat:-6.12725,lng:106.805,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTGKR',region:'NEA',lat:-6.15129,lng:106.8872,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTKGD',region:'NEA',lat:-6.171444,lng:106.916252,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'JKTPTC',region:'NEA',lat:-6.183722,lng:106.915222,status:'UP',
 sectorDefs:[{start:135,end:225},{start:225,end:315}]},
 {name:'JKTBDR',region:'SAST',lat:-6.29100,lng:106.78655,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'TGRAJS',region:'SAST',lat:-6.2958,lng:106.6802,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'TGRBIA',region:'SAST',lat:-6.2705,lng:106.7091,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'BKSCRW',region:'SEOA',lat:-6.330000,lng:107.134489,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315}]},
 {name:'BKSHHR',region:'SEOA',lat:-6.2483,lng:106.99084,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225}]},
 {name:'BKSJBB',region:'SAST',lat:-6.296083,lng:107.162247,status:'UP',
 sectorDefs:[{start:45,end:135},{start:135,end:225},{start:225,end:315},{start:315,end:45}]},
 {name:'PBRSDU',region:'CSA',lat:0.51185,lng:101.449133,status:'UP',
 sectorDefs:[{start:135,end:225}]},
 {name:'BDALTH',region:'NSA',lat:5.551675,lng:95.345611,status:'UP',
 sectorDefs:[{start:75,end:165},{start:200,end:290},{start:290,end:20}]},
 {name:'MDNCMB',region:'NSA',lat:3.584542,lng:98.666989,status:'UP',
 sectorDefs:[{start:45,end:135},{start:120,end:210},{start:315,end:45}]},
 {name:'MDNIDS',region:'NSA',lat:3.599222,lng:98.686306,status:'UP',
 sectorDefs:[{start:0,end:90},{start:180,end:270}]},
 {name:'MDNTGM',region:'NSA',lat:3.541423,lng:98.809228,status:'UP',
 sectorDefs:[{start:220,end:310}]},
 {name:'BKLHST',region:'SSA',lat:-3.79793,lng:102.27345,status:'UP',
 sectorDefs:[{start:75,end:165}]},
 {name:'BKLPDH',region:'SSA',lat:-3.82776,lng:102.29074,status:'UP',
 sectorDefs:[{start:125,end:215}]},
 {name:'PKPRKI',region:'SSA',lat:-2.15641,lng:106.13115,status:'UP',
 sectorDefs:[{start:25,end:115},{start:275,end:5}]},
 {name:'PLBBSG',region:'SSA',lat:-2.9982961,lng:104.7240517,status:'UP',
 sectorDefs:[{start:315,end:45}]},
 {name:'PLBKBN',region:'SSA',lat:-2.9200622,lng:104.7226304,status:'UP',
 sectorDefs:[{start:0,end:90},{start:270,end:360}]},

];

let coverageVisible=true;

/* ================= CREATE NODE ================= */
nodes.forEach(n=>{
  const col = n.status==='UP'
    ? ['#2563eb','#22c55e','#2563eb','#22c55e']
    : ['#dc2626','#f97316','#dc2626','#f97316'];

  n.marker = L.marker([n.lat,n.lng],{
    icon:icon(col,n.status==='DOWN')
  }).addTo(map)
   .bindPopup(`<b>${n.name}</b><br>Area: ${n.region}<br>Status: ${n.status}`);

  n.marker.on('click',e=>{
    if(rulerActive){
      addRulerPoint(e.latlng);
      L.DomEvent.stopPropagation(e);
    }
  });

  n.sectors = [];

  /* ===== JIKA ADA sectorDefs â†’ PAKAI ITU ===== */
  if(n.sectorDefs){
    n.sectorDefs.forEach((sec,idx)=>{
      const c = col[idx % col.length];
      const s = createSector(
        L.latLng(n.lat,n.lng),
        5000,
        sec.start,
        sec.end,
        {
          color:c,
          fillColor:c,
          fillOpacity:.25,
          weight:1,
          interactive:false
        }
      ).addTo(map);
      n.sectors.push(s);
    });

  /* ===== JIKA TIDAK ADA â†’ DEFAULT 4 SEKTOR ===== */
  }else{
    for(let i=0;i<4;i++){
      const s = createSector(
        L.latLng(n.lat,n.lng),
        5000,
        i*90,
        (i+1)*90,
        {
          color:col[i],
          fillColor:col[i],
          fillOpacity:.25,
          weight:1,
          interactive:false
        }
      ).addTo(map);
      n.sectors.push(s);
    }
  }
});


/* ================= TABLE & FILTER ================= */
function render(list){ const tb=document.getElementById('node-table'); tb.innerHTML=''; list.forEach(n=>{ tb.innerHTML+=`<tr onclick="focusNode('${n.name}')" style="cursor:pointer"><td>${n.name}</td><td>${n.region}</td><td class="${n.status==='UP'?'up':'down'}">${n.status}</td></tr>`; }); }
function focusNode(name){ const n=nodes.find(x=>x.name===name); map.flyTo([n.lat,n.lng],11,{animate:true,duration:1.2}); n.marker.openPopup(); }
function showAll(){ render(nodes); nodes.forEach(n=>{ n.marker.addTo(map); n.sectors.forEach(s=>coverageVisible&&s.addTo(map)); }); }
function filterRegion(r){ render(nodes.filter(n=>n.region===r)); nodes.forEach(n=>{ if(n.region===r){ n.marker.addTo(map); n.sectors.forEach(s=>coverageVisible&&s.addTo(map)); }else{ map.removeLayer(n.marker); n.sectors.forEach(s=>map.removeLayer(s)); } }); }
function toggleCoverage(){ coverageVisible=!coverageVisible; nodes.forEach(n=>n.sectors.forEach(s=>{ coverageVisible?s.addTo(map):map.removeLayer(s); })); }
function toggleTable(){ document.getElementById('node-section').classList.toggle('hidden'); }
function backToMenu(){ window.location.href="index.html"; }

showAll();

  map.on('mousemove', function(e){
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);

  document.getElementById('coords').innerHTML =
    `Lat: ${lat} | Lng: ${lng}`;
});
</script>
  <script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1XId1RBwjyv1_OUmbWy2reMm6eGMcV-M",
  authDomain: "dashboard-bwa.firebaseapp.com",
  projectId: "dashboard-bwa",
  storageBucket: "dashboard-bwa.firebasestorage.app",
  messagingSenderId: "1066238404578",
  appId: "1:1066238404578:web:ad4b911ac3f155352e3bbb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
import { collection, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* =============================
   LAYER KHUSUS USER & LINK
============================= */

const userLayer = L.layerGroup().addTo(map);
const linkLayer = L.layerGroup().addTo(map);

/* =============================
   REALTIME LOAD USERS
============================= */

onSnapshot(collection(db,"topology_users"), snapshot=>{

  // bersihkan dulu supaya tidak dobel
  userLayer.clearLayers();
  linkLayer.clearLayers();

  snapshot.forEach(doc=>{
    const u = doc.data();

    // marker user
    L.circleMarker([u.lat,u.lng],{
      radius:6,
      color:"#22c55e",
      fillColor:"#22c55e",
      fillOpacity:1
    }).addTo(userLayer)
      .bindPopup(`<b>${u.name}</b><br>Link: ${u.nodeName}`);

    // cari node tujuan dari array nodes lama
    const node = nodes.find(n=>n.name===u.nodeName);

    if(node){
      L.polyline([
        [u.lat,u.lng],
        [node.lat,node.lng]
      ],{
        color:"#22c55e",
        weight:2,
        dashArray:"4"
      }).addTo(linkLayer);
    }

  });

});
    /* =============================
   MODE TAMBAH USER
============================= */

let addUserMode = false;

window.activateAddUser = function(){
  addUserMode = true;
  alert("Klik lokasi di map untuk menambahkan user");
  map.getContainer().style.cursor = "crosshair";
};

map.on("click", async function(e){

  if(!addUserMode) return;

  addUserMode = false;
  map.getContainer().style.cursor = "";

  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  const name = prompt("Masukkan nama user:");
  if(!name) return;

  const nodeName = prompt("Link ke node mana? (contoh: SLOSRH)");
  if(!nodeName) return;

  try{
    const { addDoc, collection } = await import(
      "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
    );

    await addDoc(collection(db,"topology_users"),{
      name:name,
      lat:lat,
      lng:lng,
      nodeName:nodeName
    });

    alert("User berhasil ditambahkan & terhubung!");
  }catch(err){
    console.error(err);
    alert("Gagal menambahkan user");
  }

});
    /* =============================
   MODE TAMBAH NODE
============================= */

let addNodeMode = false;

window.activateAddNode = function(){
  addNodeMode = true;
  alert("Klik lokasi di map untuk menambahkan NODE");
  map.getContainer().style.cursor = "crosshair";
};

map.on("click", async function(e){

  if(!addNodeMode) return;

  addNodeMode = false;
  map.getContainer().style.cursor = "";

  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  const name = prompt("Masukkan nama NODE (contoh: TGRNEW01)");
  if(!name) return;

  const region = prompt("Masukkan region (contoh: BWA / EJA / CJDA)");
  if(!region) return;

  try{
    const { addDoc, collection } = await import(
      "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
    );

    await addDoc(collection(db,"nodes"),{
      name:name,
      region:region,
      lat:lat,
      lng:lng,
      status:"UP",
      sectorDefs:[
        {start:0,end:90},
        {start:90,end:180},
        {start:180,end:270},
        {start:270,end:360}
      ]
    });

    alert("NODE berhasil ditambahkan!");
  }catch(err){
    console.error(err);
    alert("Gagal menambahkan node");
  }
});
    /* =============================
   REALTIME LOAD NODE BARU
============================= */

onSnapshot(collection(db,"nodes"), snapshot=>{

  snapshot.docChanges().forEach(change=>{

    if(change.type === "added"){

      const n = change.doc.data();

      // hindari duplikat jika sudah ada di array lama
      if(nodes.find(x=>x.name === n.name)) return;

      nodes.push(n);

      const col = ['#2563eb','#22c55e','#2563eb','#22c55e'];

      n.marker = L.marker([n.lat,n.lng],{
        icon:icon(col,false)
      }).addTo(map)
       .bindPopup(`<b>${n.name}</b><br>Area: ${n.region}<br>Status: ${n.status}`);

      n.sectors = [];

      n.sectorDefs.forEach((sec,idx)=>{
        const c = col[idx % col.length];

        const s = createSector(
          L.latLng(n.lat,n.lng),
          5000,
          sec.start,
          sec.end,
          {
            color:c,
            fillColor:c,
            fillOpacity:.25,
            weight:1,
            interactive:false
          }
        ).addTo(map);

        n.sectors.push(s);
      });

      render(nodes);

    }

  });

});
console.log("ðŸ”¥ Firebase Connected");

</script>
</body>
</html>
