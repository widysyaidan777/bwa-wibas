<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi â€“ BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#020617;
  color:white
}
header{
  height:60px;
  display:flex;
  align-items:center;
  padding:0 20px;
  background:linear-gradient(90deg,#0f172a,#020617);
  font-size:22px;
  font-weight:bold
}

/* SIDEBAR */
#sidebar{
  position:fixed;
  top:60px;
  left:0;
  width:220px;
  height:calc(100vh - 60px);
  background:#020617;
  padding:12px;
  box-sizing:border-box
}
button{
  width:100%;
  margin:6px 0;
  padding:8px;
  border:none;
  border-radius:4px;
  color:white;
  cursor:pointer
}
.blue{background:#2563eb}
.gray{background:#334155}
.red{background:#dc2626}

/* MAIN */
#main{
  margin-left:220px;
  height:calc(100vh - 60px);
  display:flex;
  flex-direction:column
}
#map{flex:1}

/* RULER LABEL */
.ruler-label{
  background:#020617;
  color:#facc15;
  border:1px solid #facc15;
  padding:6px 10px;
  border-radius:6px;
  font-size:12px;
  white-space:nowrap;
}
</style>
</head>

<body>
<header>Peta Topologi â€“ BWA WiBAS</header>

<div id="sidebar">
  <h4>Ruler</h4>
  <button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
  <button class="red" onclick="resetRuler()">Reset Ruler</button>
</div>

<div id="main">
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([-6.9,110.5],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18
}).addTo(map);

/* ================= RULER ================= */
let rulerActive = false;
let p1 = null, p2 = null;
let m1 = null, m2 = null;
let rulerLine = null;
let rulerLabel = null;

function activateRuler(){
  rulerActive = true;
  clearRuler();
  map.getContainer().style.cursor = 'crosshair';
}

function resetRuler(){
  rulerActive = false;
  clearRuler();
  map.getContainer().style.cursor = '';
}

function clearRuler(){
  if(m1) map.removeLayer(m1);
  if(m2) map.removeLayer(m2);
  if(rulerLine) map.removeLayer(rulerLine);
  if(rulerLabel) map.removeLayer(rulerLabel);
  p1 = p2 = m1 = m2 = rulerLine = rulerLabel = null;
}

/* ================= BEARING ================= */
function bearing(lat1, lon1, lat2, lon2){
  const toRad = x => x * Math.PI / 180;
  const toDeg = x => (x * 180 / Math.PI + 360) % 360;

  const dLon = toRad(lon2 - lon1);
  const y = Math.sin(dLon) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);

  return toDeg(Math.atan2(y, x));
}

/* ================= UPDATE RULER ================= */
function updateRuler(){
  if(!p1 || !p2 || !rulerLine || !rulerLabel) return;

  const distKm = map.distance(p1, p2) / 1000;
  const az = bearing(p1.lat, p1.lng, p2.lat, p2.lng);

  rulerLine.setLatLngs([p1, p2]);

  const mid = L.latLng(
    (p1.lat + p2.lat) / 2,
    (p1.lng + p2.lng) / 2
  );

  rulerLabel
    .setLatLng(mid)
    .setContent(`
      <b>${distKm.toFixed(2)} km</b><br>
      Azimuth: ${az.toFixed(1)}Â°
    `);
}

/* ================= MAP CLICK ================= */
map.on('click', e => {
  if(!rulerActive) return;

  if(!p1){
    p1 = e.latlng;
    m1 = L.marker(p1,{draggable:true})
      .addTo(map)
      .on('drag', ev => {
        p1 = ev.target.getLatLng();
        updateRuler();
      });

  } else if(!p2){
    p2 = e.latlng;
    m2 = L.marker(p2,{draggable:true})
      .addTo(map)
      .on('drag', ev => {
        p2 = ev.target.getLatLng();
        updateRuler();
      });

    rulerLine = L.polyline([p1,p2],{
      color:'#facc15',
      weight:3
    }).addTo(map);

    /* ðŸ”´ PENTING: tooltip langsung dikasih posisi */
    rulerLabel = L.tooltip({
      permanent:true,
      direction:'center',
      className:'ruler-label'
    })
    .setLatLng(p2)
    .setContent('...')
    .addTo(map);

    updateRuler();
    rulerActive = false;
    map.getContainer().style.cursor = '';
  }
});
</script>
</body>
</html>
