<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Topologi – BWA WiBAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }

    header {
      height: 64px;
      background: linear-gradient(90deg, #0f172a, #020617);
      color: #fff;
      padding: 16px;
      display: flex;
      align-items: center;
    }

    #sidebar {
      position: fixed;
      top: 64px; left: 0;
      width: 220px;
      height: calc(100vh - 64px);
      background: #1e293b;
      color: #fff;
      padding: 10px;
      box-sizing: border-box;
      z-index: 1000;
      overflow-y: auto;
      transition: transform .3s;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    #sidebar.hide { transform: translateX(-100%); }

    #toggle-btn {
      position: absolute;
      top: 50%;
      left: -50px;
      width: 50px;
      height: 50px;
      background: #1e293b;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      z-index: 1100;
    }

    #map {
      margin-left: 220px;
      height: calc(100vh - 64px);
      transition: .3s;
    }

    #map.full { margin-left: 0; }

    /* Node section placed below the map */
    #node-section {
      padding: 10px;
      background-color: #1e293b;
      color: white;
      position: relative;
      top: 10px;
      margin-left: 220px;
      height: 100%;
      overflow-y: auto;
    }

    header h2 {
      margin-bottom: 20px;
    }

    #sidebar h3 {
      font-size: 18px;
      margin-top: 20px;
    }

    .node-btn {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background: #3b82f6;
      color: white;
      cursor: pointer;
      text-align: left;
    }

    .node-btn:hover { background: #2563eb; }

    /* Remove blinking animation */
    @keyframes blinkBlue { 50% { opacity: .3; } }
    @keyframes blinkRed { 50% { opacity: .3; } }

    .status-up { animation: blinkBlue 1s infinite; }
    .status-down { animation: blinkRed 1s infinite; }

    /* Styling for back button */
    #back-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1200;
      padding: 10px 15px;
      background: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Remove long blue line */
    ::-webkit-scrollbar {
      display: none;
    }
  </style>

</head>
<body>

<header>
  <h2>Peta Topologi – BWA WiBAS</h2>
</header>

<div id="sidebar">
  <div id="toggle-btn" onclick="toggleSidebar()">◀</div>

  <h3>Daftar Node</h3>
  <div id="node-buttons">
    <!-- Buttons for nodes will be dynamically added here -->
  </div>

  <hr style="border:1px solid #334155">

  <h3>Ruler Coverage</h3>
  <button class="node-btn" onclick="enableRuler()">Aktifkan Ruler</button>
  <button class="node-btn" onclick="resetRuler()" style="background:#ef4444">Reset Ruler</button>
  <div id="ruler-info" style="font-size:13px">Klik 2 titik</div>
</div>

<div id="map"></div>

<!-- Node section placed below the map -->
<div id="node-section">
  <h3>Node List</h3>
  <button class="node-btn" onclick="showAllNodes()">All</button>
</div>

<button id="back-button" onclick="window.location.href='index.html'">
  Kembali ke Menu
</button>

<script>
  /* ===== SIDEBAR ===== */
  const sidebar = document.getElementById('sidebar');
  const mapDiv = document.getElementById('map');
  const toggleBtn = document.getElementById('toggle-btn');

  function toggleSidebar() {
    sidebar.classList.toggle('hide');
    mapDiv.classList.toggle('full');
    toggleBtn.innerHTML = sidebar.classList.contains('hide') ? '▶' : '◀';
  }

  /* ===== MAP ===== */
  const map = L.map('map').setView([-6.291, 106.786], 11.8);
  L.tileLayer(
    'https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=fI3LpQe8kMXj5ntFo68C',
    { attribution: '© MapTiler © OpenStreetMap' }
  ).addTo(map);

  /* ===== SECTOR METER (AKURAT) ===== */
  function destinationPoint(lat, lng, bearing, dist) {
    const R = 6378137;
    const br = bearing * Math.PI / 180;
    const d = dist;
    const lat1 = lat * Math.PI / 180;
    const lon1 = lng * Math.PI / 180;
    const lat2 = Math.asin(
      Math.sin(lat1) * Math.cos(d / R) +
      Math.cos(lat1) * Math.sin(d / R) * Math.cos(br)
    );
    const lon2 = lon1 + Math.atan2(
      Math.sin(br) * Math.sin(d / R) * Math.cos(lat1),
      Math.cos(d / R) - Math.sin(lat1) * Math.sin(lat2)
    );
    return [lat2 * 180 / Math.PI, lon2 * 180 / Math.PI];
  }

  function drawSector(center, start, end, radius, color) {
    const pts = [center];
    for (let a = start; a <= end; a += 2) {
      pts.push(destinationPoint(center[0], center[1], a, radius));
    }
    return L.polygon(pts, {
      color,
      fillColor: color,
      fillOpacity: 0.35,
      weight: 1
    });
  }

  /* ===== NODE ===== */
  const nodes = {};

  const javaCoordinates = [
    [-6.2088, 106.8456], [-6.2500, 106.8500], [-6.3000, 106.8000], [-6.1500, 106.5000], [-6.3000, 106.9000],
    [-6.2500, 107.0000], [-6.2000, 107.1000], [-6.3000, 106.7000], [-6.3500, 106.8000], [-6.1000, 106.6000],
    // Add 20 more coordinates for Java
  ];

  const sumatraCoordinates = [
    [3.5952, 98.6741], [3.6000, 98.7000], [3.7000, 99.2000], [3.8000, 99.3000], [4.0000, 99.1000],
    [3.9000, 98.9000], [4.2000, 98.5000], [3.7000, 98.8000], [4.1000, 98.6000], [3.8000, 99.2000],
    // Add 20 more coordinates for Sumatra
  ];

  const kalimantanCoordinates = [
    [1.3000, 116.5000], [1.4000, 116.6000], [1.5000, 116.7000], [1.6000, 116.8000], [1.7000, 116.9000],
    [1.8000, 117.0000], [1.9000, 117.1000], [1.7000, 116.6000], [1.8000, 116.5000], [1.6000, 116.3000],
    // Add 10 more coordinates for Kalimantan
  ];

  const baliCoordinates = [
    [-8.3405, 115.0919], [-8.2000, 115.1000], [-8.3000, 115.3000], [-8.4000, 115.4000], [-8.5000, 115.5000],
    [-8.6000, 115.6000], [-8.7000, 115.7000], [-8.8000, 115.8000], [-8.9000, 115.9000], [-8.9500, 116.0000],
    // Add 10 more coordinates for Bali
  ];

  // Function to randomly assign status and create node
  function createNode(name, center, status) {
    const color = status === 'up' ? 'blue' : 'red';
    const blink = status === 'up' ? 'status-up' : 'status-down';
    const r = 5000;

    const layers = [
      drawSector(center, 0, 90, r, color),
      drawSector(center, 90, 180, r, color),
      drawSector(center, 180, 270, r, color),
      drawSector(center, 270, 360, r, color),
      L.circleMarker(center, {
        radius: 9,
        color,
        fillColor: color,
        fillOpacity: 1,
        className: blink
      }).bindPopup(
        `<b>${name}</b><br>Status: ${status.toUpperCase()}<br>Coverage: 5 km`
      )
    ];
    nodes[name] = { layers, center };
  }

  // Create nodes for each region
  const allCoordinates = [...javaCoordinates, ...sumatraCoordinates, ...kalimantanCoordinates, ...baliCoordinates];
  allCoordinates.forEach((coord, i) => {
    const status = Math.random() > 0.5 ? 'up' : 'down';
    createNode('Node ' + (i + 1), coord, status);

    // Dynamically create the button for each node
    const button = document.createElement('button');
    button.classList.add('node-btn');
    button.textContent = 'Node ' + (i + 1);
    button.onclick = () => showNode('Node ' + (i + 1));
    document.getElementById('node-buttons').appendChild(button);
  });

  function clearMap() {
    Object.values(nodes).forEach(n => n.layers.forEach(l => map.removeLayer(l)));
  }

  function showNode(n) {
    clearMap();
    nodes[n].layers.forEach(l => l.addTo(map));
    map.flyTo(nodes[n].center, 12.5);
  }

  function showAllNodes() {
    clearMap();
    Object.values(nodes).forEach(n => n.layers.forEach(l => l.addTo(map)));
  }

  showAllNodes();

  /* ===== RULER BULAT + DRAG ===== */
  let rulerActive = false;
  let rulerMarkers = [];
  let rulerVisuals = [];
  let rulerLine = null;
  const rulerInfo = document.getElementById('ruler-info');

  function enableRuler() {
    resetRuler();
    rulerActive = true;
    rulerInfo.innerHTML = 'Klik titik pusat lalu ujung';
  }

  function resetRuler() {
    rulerActive = false;
    rulerMarkers.forEach(m => map.removeLayer(m));
    rulerVisuals.forEach(v => map.removeLayer(v));
    rulerMarkers = [];
    rulerVisuals = [];
    if (rulerLine) map.removeLayer(rulerLine);
    rulerLine = null;
    rulerInfo.innerHTML = 'Klik 2 titik';
  }

  function updateRuler() {
    const p1 = rulerMarkers[0].getLatLng();
    const p2 = rulerMarkers[1].getLatLng();
    rulerLine.setLatLngs([p1, p2]);
    rulerVisuals[0].setLatLng(p1);
    rulerVisuals[1].setLatLng(p2);
    const km = (p1.distanceTo(p2) / 1000).toFixed(2);
    rulerInfo.innerHTML = `<b>Jarak:</b> ${km} km`;
    rulerLine.bindPopup(`Jarak: <b>${km} km</b>`).openPopup();
  }

  map.on('click', e => {
    if (!rulerActive || rulerMarkers.length >= 2) return;

    const hidden = L.marker(e.latlng, { draggable: true }).addTo(map);
    const visual = L.circleMarker(e.latlng, {
      radius: 7,
      color: 'yellow',
      fillColor: 'yellow',
      fillOpacity: 1
    }).addTo(map);

    hidden.on('drag', () => {
      visual.setLatLng(hidden.getLatLng());
      updateRuler();
    });

    rulerMarkers.push(hidden);
    rulerVisuals.push(visual);

    if (rulerMarkers.length === 2) {
      rulerActive = false;
      rulerLine = L.polyline(
        rulerMarkers.map(m => m.getLatLng()),
        { color: 'yellow', dashArray: '6,6', weight: 3 }
      ).addTo(map);
      updateRuler();
    }
  });
</script>

</body>
</html>
