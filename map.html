<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Topologi â€“ BWA WiBAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }

    header {
      height: 64px;
      background: linear-gradient(90deg,#0f172a,#020617);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
    }

    #sidebar {
      position: fixed;
      top: 64px;
      left: 0;
      width: 220px;
      height: calc(100vh - 64px);
      background: #1e293b;
      color: white;
      padding: 10px;
      box-sizing: border-box;
      z-index: 1000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    #sidebar.hide { transform: translateX(-100%); }

    #sidebar h3 { font-size: 15px; }

    .node-btn {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background: #3b82f6;
      color: white;
      cursor: pointer;
      text-align: left;
    }

    .node-btn:hover { background: #2563eb; }

    #toggle-btn {
      position: absolute;
      top: 10px;
      right: -30px;
      width: 30px;
      height: 40px;
      background: #1e293b;
      color: white;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #map {
      margin-left: 220px;
      height: calc(100vh - 64px);
      transition: margin-left 0.3s ease;
    }

    #map.full { margin-left: 0; }

    #back-button {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1200;
      padding: 10px 15px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    @keyframes blinkBlue { 50% { opacity: 0.3; } }
    @keyframes blinkRed { 50% { opacity: 0.3; } }

    .status-up { animation: blinkBlue 1s infinite; }
    .status-down { animation: blinkRed 1s infinite; }
  </style>
</head>

<body>

<header>
  <h2>Peta Topologi â€“ BWA WiBAS</h2>
</header>

<div id="sidebar">
  <div id="toggle-btn" onclick="toggleSidebar()">â—€</div>

  <h3>Daftar Node</h3>
  <button class="node-btn" onclick="showAllNodes()">All</button>
  <button class="node-btn" onclick="showNode('node1')">Node 1</button>
  <button class="node-btn" onclick="showNode('node2')">Node 2</button>
  <button class="node-btn" onclick="showNode('node3')">Node 3</button>

  <hr style="border:1px solid #334155">

  <h3>Ruler Coverage</h3>
  <button class="node-btn" onclick="enableRuler()">Aktifkan Ruler</button>
  <button class="node-btn" onclick="resetRuler()" style="background:#ef4444">Reset Ruler</button>
  <div id="ruler-info" style="font-size:13px">Klik 2 titik</div>
</div>

<div id="map"></div>

<button id="back-button" onclick="window.location.href='index.html'">
  Kembali ke Menu
</button>

<script>
/* ===== SIDEBAR ===== */
function toggleSidebar() {
  sidebar.classList.toggle('hide');
  mapDiv.classList.toggle('full');
  toggleBtn.innerHTML = sidebar.classList.contains('hide') ? 'â–¶' : 'â—€';
}
const sidebar = document.getElementById('sidebar');
const mapDiv = document.getElementById('map');
const toggleBtn = document.getElementById('toggle-btn');

/* ===== MAP ===== */
const map = L.map('map').setView([-6.291, 106.786], 11.8);
L.tileLayer(
  'https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=fI3LpQe8kMXj5ntFo68C',
  { attribution: 'Â© MapTiler Â© OpenStreetMap contributors' }
).addTo(map);

/* ===== FIX COVERAGE 5 KM ===== */
function drawCoverage(center, color) {
  return L.circle(center, {
    radius: 5000,            // âœ… FIX 5 KM
    color: color,
    fillColor: color,
    fillOpacity: 0.35
  });
}

/* ===== NODE SYSTEM ===== */
const nodes = {};

function createNode(name, center, status) {
  const color = status === 'up' ? 'blue' : 'red';
  const blink = status === 'up' ? 'status-up' : 'status-down';

  const layers = [
    drawCoverage(center, color), // ðŸ”µ 5 KM FIX
    L.circleMarker(center, {
      radius: 9,
      color,
      fillColor: color,
      fillOpacity: 1,
      className: blink
    }).bindPopup(
      `<b>${name}</b><br>Status: ${status.toUpperCase()}<br>Coverage: 5 km`
    )
  ];

  nodes[name] = { layers, center };
}

createNode('node1', [-6.291, 106.786], 'up');
createNode('node2', [-6.260, 106.800], 'down');
createNode('node3', [-6.320, 106.760], 'up');

function clearMap() {
  Object.values(nodes).forEach(n =>
    n.layers.forEach(l => map.removeLayer(l))
  );
}

function showNode(name) {
  clearMap();
  nodes[name].layers.forEach(l => l.addTo(map));
  map.flyTo(nodes[name].center, 12.5);
}

function showAllNodes() {
  clearMap();
  Object.values(nodes).forEach(n =>
    n.layers.forEach(l => l.addTo(map))
  );
}

showAllNodes();

/* ===== RULER (DRAGGABLE) ===== */
let rulerActive = false;
let rulerMarkers = [];
let rulerLine = null;

function enableRuler() {
  resetRuler();
  rulerActive = true;
  rulerInfo.innerHTML = 'Klik titik pusat lalu titik ujung';
}

function resetRuler() {
  rulerActive = false;
  rulerMarkers.forEach(m => map.removeLayer(m));
  rulerMarkers = [];
  if (rulerLine) map.removeLayer(rulerLine);
  rulerLine = null;
  rulerInfo.innerHTML = 'Klik Kiri';
}

function updateRuler() {
  if (rulerMarkers.length !== 2) return;
  const p1 = rulerMarkers[0].getLatLng();
  const p2 = rulerMarkers[1].getLatLng();
  rulerLine.setLatLngs([p1, p2]);
  const km = (p1.distanceTo(p2) / 1000).toFixed(2);
  rulerInfo.innerHTML = `<b>Jarak:</b> ${km} km`;
  rulerLine.bindPopup(`Jarak: <b>${km} km</b>`).openPopup();
}

const rulerInfo = document.getElementById('ruler-info');

map.on('click', function(e) {
  if (!rulerActive || rulerMarkers.length >= 2) return;

  const marker = L.marker(e.latlng, {
    draggable: true,
    icon: L.divIcon({
      html: '<div style="width:12px;height:12px;background:yellow;border-radius:50%"></div>'
    })
  }).addTo(map);

  marker.on('drag', updateRuler);
  rulerMarkers.push(marker);

  if (rulerMarkers.length === 2) {
    rulerActive = false;
    rulerLine = L.polyline(
      rulerMarkers.map(m => m.getLatLng()),
      { color: 'yellow', dashArray: '6,6', weight: 3 }
    ).addTo(map);
    updateRuler();
  }
});
</script>

</body>
</html>
