<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#020617;
  color:white
}
header{
  height:60px;
  display:flex;
  align-items:center;
  padding:0 20px;
  background:linear-gradient(90deg,#0f172a,#020617);
  font-size:22px;
  font-weight:bold
}
#sidebar{
  position:fixed;
  top:60px;
  left:0;
  width:220px;
  height:calc(100vh - 60px);
  background:#020617;
  padding:12px;
}
button{
  width:100%;
  margin:6px 0;
  padding:8px;
  border:none;
  border-radius:4px;
  color:white;
  cursor:pointer
}
.blue{background:#2563eb}
.gray{background:#334155}
.red{background:#dc2626}
#main{
  margin-left:220px;
  height:calc(100vh - 60px);
  display:flex;
  flex-direction:column
}
#map{flex:1}
#toggle{
  text-align:center;
  padding:6px;
  background:#020617;
  border-top:1px solid #334155;
  cursor:pointer
}
#node-section{
  max-height:260px;
  overflow:auto;
  background:#1e293b;
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #334155}
.up{color:#22c55e}
.down{color:#ef4444}

@keyframes blink{50%{opacity:.3}}
.node-blink{animation:blink 1s infinite}
.node-blink.fast{animation:blink .4s infinite}

.ruler-label{
  background:#020617;
  color:#facc15;
  border:1px solid #facc15;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.leaflet-popup-content-wrapper{
  background:#020617;
  color:white;
  border:1px solid #facc15;
}
.leaflet-popup-tip{background:#020617}
</style>
</head>

<body>
<header>Peta Topologi – BWA WiBAS</header>

<div id="sidebar">
  <button class="gray" onclick="history.back()">⬅ Kembali ke Menu</button>
  <hr>
  <button class="blue" onclick="showAll()">All</button>
  <button class="gray" onclick="filterRegion('CJDA')">CJDA</button>
  <button class="gray" onclick="filterRegion('WJA')">WJA</button>
  <button class="gray" onclick="filterRegion('BNA')">BNA</button>
  <hr>
  <button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
  <button class="red" onclick="resetRuler()">Reset Ruler</button>
</div>

<div id="main">
  <div id="map"></div>
  <div id="toggle" onclick="toggleTable()">▲ / ▼</div>
  <div id="node-section">
    <table>
      <thead><tr><th>Node</th><th>Area</th><th>Status</th></tr></thead>
      <tbody id="node-table"></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([-6.9,110.5],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ===== RULER ===== */
let rulerActive=false,p1=null,p2=null,m1=null,m2=null,rulerLine=null,rulerLabel=null;

function activateRuler(){
  rulerActive=true; clearRuler();
  map.getContainer().style.cursor='crosshair';
}
function resetRuler(){
  rulerActive=false; clearRuler();
  map.getContainer().style.cursor='';
}
function clearRuler(){
  [m1,m2,rulerLine,rulerLabel].forEach(x=>x&&map.removeLayer(x));
  p1=p2=m1=m2=rulerLine=rulerLabel=null;
}

function bearing(lat1,lon1,lat2,lon2){
  const toRad=x=>x*Math.PI/180,toDeg=x=>(x*180/Math.PI+360)%360;
  const dLon=toRad(lon2-lon1);
  const y=Math.sin(dLon)*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-
          Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon);
  return toDeg(Math.atan2(y,x));
}

function updateRuler(){
  const dist=map.distance(p1,p2)/1000;
  const az=bearing(p1.lat,p1.lng,p2.lat,p2.lng);
  const mid=L.latLng((p1.lat+p2.lat)/2,(p1.lng+p2.lng)/2);

  rulerLine.setLatLngs([p1,p2]);
  rulerLabel.setLatLng(mid).setContent(`<b>${dist.toFixed(2)} km</b><br>${az.toFixed(1)}°`);

  rulerLine.bindPopup(`
    <b>Ruler Info</b><hr>
    Distance: <b>${dist.toFixed(2)} km</b><br>
    Azimuth: <b>${az.toFixed(1)}°</b>
  `).openPopup();
}

map.on('click',e=>{
  if(!rulerActive) return;
  if(!p1){
    p1=e.latlng;
    m1=L.marker(p1,{draggable:true}).addTo(map)
      .on('drag',ev=>{p1=ev.target.getLatLng();updateRuler();});
  }else if(!p2){
    p2=e.latlng;
    m2=L.marker(p2,{draggable:true}).addTo(map)
      .on('drag',ev=>{p2=ev.target.getLatLng();updateRuler();});
    rulerLine=L.polyline([p1,p2],{color:'#facc15',weight:3}).addTo(map);
    rulerLabel=L.tooltip({permanent:true,className:'ruler-label'}).addTo(map);
    updateRuler();
    rulerActive=false;
    map.getContainer().style.cursor='';
  }
});

/* ===== NODE ===== */
const nodes=[
 {name:'SLOSRH',region:'CJDA',lat:-7.7956,lng:110.3695,status:'UP'},
 {name:'BDGBBPB',region:'WJA',lat:-6.836141,lng:107.48698,status:'UP'},
 {name:'BDGCLY',region:'WJA',lat:-6.940522,lng:107.75132,status:'DOWN'},
 {name:'DPSIKT',region:'BNA',lat:-8.735832,lng:115.178706,status:'UP'}
];

function icon(colors,fast=false){
 return L.divIcon({
  className:`node-blink ${fast?'fast':''}`,
  iconSize:[36,36],
  html:`<svg viewBox="0 0 100 100">
   <circle cx="50" cy="50" r="45" fill="${colors[0]}"/></svg>`
 });
}

nodes.forEach(n=>{
 const col=n.status==='UP'?['#22c55e']:['#ef4444'];
 n.marker=L.marker([n.lat,n.lng],{icon:icon(col,n.status==='DOWN')})
 .addTo(map).bindPopup(`<b>${n.name}</b><br>${n.region}`);
});

/* ===== TABLE ===== */
function render(list){
 document.getElementById('node-table').innerHTML=list.map(n=>`
 <tr onclick="map.flyTo([${n.lat},${n.lng}],11)">
  <td>${n.name}</td><td>${n.region}</td>
  <td class="${n.status==='UP'?'up':'down'}">${n.status}</td>
 </tr>`).join('');
}
function showAll(){render(nodes)}
function filterRegion(r){render(nodes.filter(n=>n.region===r))}
function toggleTable(){document.getElementById('node-section').classList.toggle('hidden')}

showAll();
</script>
</body>
</html>
