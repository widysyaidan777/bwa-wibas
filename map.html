<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#0f172a; }

header {
  height:64px;
  background:linear-gradient(90deg,#0f172a,#020617);
  color:#fff;
  padding:16px;
  display:flex;
  align-items:center;
}

/* ===== SIDEBAR ===== */
#sidebar {
  position:fixed;
  top:64px; left:0;
  width:220px;
  height:calc(100vh - 64px);
  background:#1e293b;
  color:white;
  padding:12px;
  box-sizing:border-box;
  z-index:1000;
  overflow-y:auto;
  transition:.3s;
}
#sidebar.hide { transform:translateX(-100%); }

#toggle-btn {
  position:absolute;
  top:50%;
  left:-45px;
  width:45px;
  height:45px;
  background:#1e293b;
  border-radius:50%;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
}

/* ===== MAP ===== */
#map {
  margin-left:220px;
  height:calc(100vh - 64px - 260px);
  transition:.3s;
}
#map.full { margin-left:0; }

/* ===== NODE SECTION ===== */
#node-section {
  margin-left:220px;
  background:#1e293b;
  color:white;
  padding:12px;
  max-height:260px;
  overflow-y:auto;
  transition:.3s;
}
#map.full + #node-section { margin-left:0; }

.node-btn {
  width:100%;
  margin-bottom:8px;
  padding:10px;
  border:none;
  border-radius:4px;
  background:#3b82f6;
  color:white;
  cursor:pointer;
  text-align:left;
}
.node-btn:hover { background:#2563eb; }

.status-up { animation:blinkBlue 1s infinite; }
.status-down { animation:blinkRed 1s infinite; }

@keyframes blinkBlue { 50%{opacity:.3;} }
@keyframes blinkRed { 50%{opacity:.3;} }

#back-button {
  position:absolute;
  top:12px;
  right:12px;
  z-index:1200;
  padding:10px 14px;
  background:#334155;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h2>Peta Topologi – BWA WiBAS</h2>
</header>

<!-- ===== SIDEBAR ===== -->
<div id="sidebar">
  <div id="toggle-btn" onclick="toggleSidebar()">◀</div>

  <h3>Ruler Coverage</h3>
  <button class="node-btn" onclick="enableRuler()">Aktifkan Ruler</button>
  <button class="node-btn" onclick="resetRuler()" style="background:#ef4444">
    Reset Ruler
  </button>
  <div id="ruler-info" style="font-size:13px">Klik 2 titik</div>
</div>

<!-- ===== MAP ===== -->
<div id="map"></div>

<!-- ===== NODE LIST (DI BAWAH MAP) ===== -->
<div id="node-section">
  <h3>Daftar Node</h3>
  <button class="node-btn" onclick="showAllNodes()">All</button>
  <div id="node-buttons"></div>
</div>

<button id="back-button" onclick="location.href='index.html'">
  Kembali ke Menu
</button>

<script>
/* ===== SIDEBAR ===== */
const sidebar = document.getElementById('sidebar');
const mapDiv = document.getElementById('map');
const toggleBtn = document.getElementById('toggle-btn');

function toggleSidebar(){
  sidebar.classList.toggle('hide');
  mapDiv.classList.toggle('full');
  toggleBtn.innerHTML = sidebar.classList.contains('hide') ? '▶' : '◀';
}

/* ===== MAP ===== */
const map = L.map('map').setView([-6.291,106.786],11.5);
L.tileLayer(
  'https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=fI3LpQe8kMXj5ntFo68C',
  { attribution:'© MapTiler © OpenStreetMap' }
).addTo(map);

/* ===== SECTOR ===== */
function destinationPoint(lat,lng,bearing,dist){
  const R=6378137;
  const br=bearing*Math.PI/180;
  const d=dist;
  const lat1=lat*Math.PI/180;
  const lon1=lng*Math.PI/180;
  const lat2=Math.asin(
    Math.sin(lat1)*Math.cos(d/R)+
    Math.cos(lat1)*Math.sin(d/R)*Math.cos(br)
  );
  const lon2=lon1+Math.atan2(
    Math.sin(br)*Math.sin(d/R)*Math.cos(lat1),
    Math.cos(d/R)-Math.sin(lat1)*Math.sin(lat2)
  );
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

function drawSector(center,start,end,radius,color){
  const pts=[center];
  for(let a=start;a<=end;a+=2){
    pts.push(destinationPoint(center[0],center[1],a,radius));
  }
  return L.polygon(pts,{
    color, fillColor:color, fillOpacity:.35, weight:1
  });
}

/* ===== NODES ===== */
const nodes={};

const coords=[
  [-6.2088,106.8456],[-6.25,106.85],[-6.3,106.8],
  [-6.15,106.5],[-6.3,106.9],[-6.25,107.0],
  [-6.2,107.1],[-6.35,106.8],[-6.1,106.6]
];

function createNode(name,center,status){
  const color=status==='up'?'blue':'red';
  const blink=status==='up'?'status-up':'status-down';
  const r=5000;

  const layers=[
    drawSector(center,0,90,r,color),
    drawSector(center,90,180,r,color),
    drawSector(center,180,270,r,color),
    drawSector(center,270,360,r,color),
    L.circleMarker(center,{
      radius:9,color,fillColor:color,fillOpacity:1,className:blink
    }).bindPopup(`<b>${name}</b><br>Status: ${status.toUpperCase()}<br>Coverage: 5 km`)
  ];
  nodes[name]={layers,center};
}

coords.forEach((c,i)=>{
  const status=Math.random()>0.5?'up':'down';
  const name='Node '+(i+1);
  createNode(name,c,status);

  const btn=document.createElement('button');
  btn.className='node-btn';
  btn.innerText=name;
  btn.onclick=()=>showNode(name);
  document.getElementById('node-buttons').appendChild(btn);
});

function clearMap(){
  Object.values(nodes).forEach(n=>n.layers.forEach(l=>map.removeLayer(l)));
}

function showNode(n){
  clearMap();
  nodes[n].layers.forEach(l=>l.addTo(map));
  map.flyTo(nodes[n].center,12.5);
}

function showAllNodes(){
  clearMap();
  Object.values(nodes).forEach(n=>n.layers.forEach(l=>l.addTo(map)));
}

showAllNodes();

/* ===== RULER ===== */
let rulerActive=false, rulerMarkers=[], rulerVisuals=[], rulerLine=null;
const rulerInfo=document.getElementById('ruler-info');

function enableRuler(){
  resetRuler();
  rulerActive=true;
  rulerInfo.innerHTML='Klik titik pusat lalu ujung';
}

function resetRuler(){
  rulerActive=false;
  rulerMarkers.forEach(m=>map.removeLayer(m));
  rulerVisuals.forEach(v=>map.removeLayer(v));
  rulerMarkers=[]; rulerVisuals=[];
  if(rulerLine) map.removeLayer(rulerLine);
  rulerLine=null;
  rulerInfo.innerHTML='Klik 2 titik';
}

function updateRuler(){
  const p1=rulerMarkers[0].getLatLng();
  const p2=rulerMarkers[1].getLatLng();
  rulerLine.setLatLngs([p1,p2]);
  const km=(p1.distanceTo(p2)/1000).toFixed(2);
  rulerInfo.innerHTML=`Jarak: ${km} km`;
}

map.on('click',e=>{
  if(!rulerActive||rulerMarkers.length>=2) return;

  const m=L.marker(e.latlng,{draggable:true}).addTo(map);
  m.on('drag',updateRuler);
  rulerMarkers.push(m);

  if(rulerMarkers.length===2){
    rulerActive=false;
    rulerLine=L.polyline(
      rulerMarkers.map(m=>m.getLatLng()),
      {color:'yellow',dashArray:'6,6',weight:3}
    ).addTo(map);
    updateRuler();
  }
});
</script>

</body>
</html>
