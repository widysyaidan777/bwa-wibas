<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#020617;color:white}
header{height:60px;display:flex;align-items:center;padding:0 20px;background:linear-gradient(90deg,#0f172a,#020617);font-size:22px;font-weight:bold}
#sidebar{position:fixed;top:60px;left:0;width:220px;height:calc(100vh - 60px);background:#020617;padding:12px;overflow-y:auto}
button{width:100%;margin:4px 0;padding:8px;border:none;border-radius:4px;color:white;cursor:pointer}
.blue{background:#2563eb}.gray{background:#334155}.red{background:#dc2626}
.submenu{display:none;margin-left:12px}
.submenu button{font-size:13px;background:#1e293b}
#main{margin-left:220px;height:calc(100vh - 60px);display:flex;flex-direction:column}
#map{flex:1}
#toggle{text-align:center;padding:6px;background:#020617;border-top:1px solid #334155;cursor:pointer}
#node-section{max-height:260px;overflow:auto;background:#1e293b;transition:.3s}
#node-section.hidden{max-height:0}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #334155}
th{background:#020617}
.up{color:#22c55e}.down{color:#ef4444}
@keyframes blink{0%{opacity:1}50%{opacity:.35}100%{opacity:1}}
.node-blink{animation:blink 1s infinite}
.node-blink.fast{animation:blink .4s infinite}
.ruler-label{background:#020617;color:#facc15;border:1px solid #facc15;padding:4px 8px;border-radius:4px;font-size:12px}
</style>
</head>

<body>
<header>Peta Topologi – BWA WiBAS</header>

<div id="sidebar">
<h4>Area</h4>
<button class="blue" onclick="showAll()">All</button>

<button class="gray" onclick="toggleSubmenu('CRO')">CRO ▼</button>
<div class="submenu" id="submenu-CRO">
<button onclick="filterRegion('CJDA')">CJDA</button>
<button onclick="filterRegion('KAA')">KAA</button>
<button onclick="filterRegion('WJA')">WJA</button>
</div>

<button class="gray" onclick="toggleSubmenu('ERO')">ERO ▼</button>
<div class="submenu" id="submenu-ERO">
<button onclick="filterRegion('BNA')">BNA</button>
<button onclick="filterRegion('EJA')">EJA</button>
<button onclick="filterRegion('MAPUA')">MAPUA</button>
</div>

<button class="gray" onclick="toggleSubmenu('GJO')">GJO ▼</button>
<div class="submenu" id="submenu-GJO">
<button onclick="filterRegion('BWA')">BWA</button>
<button onclick="filterRegion('BDA')">BDA</button>
<button onclick="filterRegion('CDA')">CDA</button>
<button onclick="filterRegion('NEA')">NEA</button>
<button onclick="filterRegion('SAST')">SAST</button>
<button onclick="filterRegion('SEOA')">SEOA</button>
</div>

<button class="gray" onclick="toggleSubmenu('WRO')">WRO ▼</button>
<div class="submenu" id="submenu-WRO">
<button onclick="filterRegion('CSA')">CSA</button>
<button onclick="filterRegion('NSA')">NSA</button>
<button onclick="filterRegion('SSA')">SSA</button>
</div>

<hr style="border:1px solid #334155">
<h4>Ruler</h4>
<button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
<button class="red" onclick="resetRuler()">Reset Ruler</button>
<hr style="border:1px solid #334155">
<button class="gray" onclick="toggleCoverage()">Toggle Coverage</button>
<button class="blue" onclick="backToMenu()">Kembali ke Menu</button>
</div>

<div id="main">
<div id="map"></div>
<div id="toggle" onclick="toggleTable()">▲ / ▼</div>
<div id="node-section">
<table>
<thead><tr><th>Node</th><th>Area</th><th>Status</th></tr></thead>
<tbody id="node-table"></tbody>
</table>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
function toggleSubmenu(r){const e=document.getElementById('submenu-'+r);e.style.display=e.style.display==='block'?'none':'block';}

const map=L.map('map').setView([-6.9,110.5],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ================= RULER ================= */
let rulerActive=false,rulerPoints=[],rulerLine=null,rulerMarkers=[],rulerLabel=null;
function activateRuler(){resetRuler();rulerActive=true;map.getContainer().style.cursor='crosshair'}
function resetRuler(){rulerActive=false;rulerPoints=[];if(rulerLine)map.removeLayer(rulerLine);rulerMarkers.forEach(m=>map.removeLayer(m));if(rulerLabel)map.removeLayer(rulerLabel);rulerLine=null;rulerMarkers=[];rulerLabel=null;map.getContainer().style.cursor=''}
function calculateAzimuth(p1,p2){const dLon=(p2.lng-p1.lng)*Math.PI/180;const y=Math.sin(dLon)*Math.cos(p2.lat*Math.PI/180);const x=Math.cos(p1.lat*Math.PI/180)*Math.sin(p2.lat*Math.PI/180)-Math.sin(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.cos(dLon);return(Math.atan2(y,x)*180/Math.PI+360)%360}
function addRulerPoint(ll){
if(rulerPoints.length>=2)return;
rulerPoints.push(ll);
const m=L.marker(ll,{draggable:true,icon:L.divIcon({iconSize:[12,12],html:'<div style="width:12px;height:12px;border-radius:50%;background:#facc15"></div>'})}).addTo(map);
m.on('drag',()=>updateRuler());
rulerMarkers.push(m);
if(rulerPoints.length===2){
rulerLine=L.polyline(rulerPoints,{color:'#facc15'}).addTo(map);
rulerLabel=L.tooltip({permanent:true,className:'ruler-label'}).addTo(map);
updateRuler();rulerActive=false;map.getContainer().style.cursor='';
}}
function updateRuler(){
rulerPoints=rulerMarkers.map(m=>m.getLatLng());
rulerLine.setLatLngs(rulerPoints);
const d=map.distance(rulerPoints[0],rulerPoints[1])/1000;
const az=calculateAzimuth(rulerPoints[0],rulerPoints[1]);
const mid=[(rulerPoints[0].lat+rulerPoints[1].lat)/2,(rulerPoints[0].lng+rulerPoints[1].lng)/2];
rulerLabel.setLatLng(mid).setContent(`${d.toFixed(2)} km<br>Azimuth: ${az.toFixed(1)}°`);
}
map.on('click',e=>{if(rulerActive)addRulerPoint(e.latlng)});

/* ================= ICON & SECTOR ================= */
function icon(c,f){return L.divIcon({className:`node-blink ${f?'fast':''}`,iconSize:[36,36],iconAnchor:[18,18],html:`<svg viewBox="0 0 100 100"><path d="M50 50 L50 0 A50 50 0 0 1 100 50 Z" fill="${c[0]}"/><path d="M50 50 L100 50 A50 50 0 0 1 50 100 Z" fill="${c[1]}"/><path d="M50 50 L50 100 A50 50 0 0 1 0 50 Z" fill="${c[2]}"/><path d="M50 50 L0 50 A50 50 0 0 1 50 0 Z" fill="${c[3]}"/><circle cx="50" cy="50" r="9" fill="#020617" stroke="white" stroke-width="2"/></svg>`})}
function createSector(c,r,s,e,o){
const pts=[c];
for(let a=s;a<=e;a+=5){
const rad=a*Math.PI/180;
pts.push(L.latLng(c.lat+(r*Math.sin(rad))/111320,c.lng+(r*Math.cos(rad))/(111320*Math.cos(c.lat*Math.PI/180))));
}
pts.push(c);return L.polygon(pts,o);
}

/* ================= NODE DATA ================= */
const nodes=[
{name:'SDJCNG',region:'EJA',lat:-7.407205,lng:112.618979,status:'UP',
 sectorDefs:[{start:90,end:210}]},
{name:'SBYPGT',region:'EJA',lat:-7.234389,lng:112.773033,status:'UP',
 sectorDefs:[{start:0,end:120},{start:180,end:300}]},

{name:'GRSTGP',region:'EJA',lat:-7.15068,lng:112.646615,status:'UP'},
{name:'MJKGTO',region:'EJA',lat:-7.484068,lng:112.439306,status:'UP'}
];

/* ================= CREATE NODE ================= */
nodes.forEach(n=>{
const col=n.status==='UP'?['#2563eb','#22c55e','#2563eb','#22c55e']:['#dc2626','#f97316','#dc2626','#f97316'];
n.marker=L.marker([n.lat,n.lng],{icon:icon(col,n.status==='DOWN')}).addTo(map)
.bindPopup(`<b>${n.name}</b><br>Area: ${n.region}<br>Status: ${n.status}`);
n.sectors=[];
if(n.sectorDefs){
n.sectorDefs.forEach((s,i)=>{
const c=col[i%4];
n.sectors.push(createSector(L.latLng(n.lat,n.lng),5000,s.start,s.end,{color:c,fillColor:c,fillOpacity:.25,weight:1}).addTo(map));
});
}else{
for(let i=0;i<4;i++){
n.sectors.push(createSector(L.latLng(n.lat,n.lng),5000,i*90,(i+1)*90,{color:col[i],fillColor:col[i],fillOpacity:.25,weight:1}).addTo(map));
}}
});

/* ================= FILTER ================= */
function render(l){const t=document.getElementById('node-table');t.innerHTML='';l.forEach(n=>t.innerHTML+=`<tr onclick="focusNode('${n.name}')"><td>${n.name}</td><td>${n.region}</td><td class="${n.status==='UP'?'up':'down'}">${n.status}</td></tr>`)}
function focusNode(n){const x=nodes.find(a=>a.name===n);map.flyTo([x.lat,x.lng],11);x.marker.openPopup()}
function showAll(){render(nodes);nodes.forEach(n=>{n.marker.addTo(map);n.sectors.forEach(s=>coverageVisible&&s.addTo(map))})}
function filterRegion(r){render(nodes.filter(n=>n.region===r));nodes.forEach(n=>{if(n.region===r){n.marker.addTo(map);n.sectors.forEach(s=>coverageVisible&&s.addTo(map))}else{map.removeLayer(n.marker);n.sectors.forEach(s=>map.removeLayer(s))}})}
let coverageVisible=true;
function toggleCoverage(){coverageVisible=!coverageVisible;nodes.forEach(n=>n.sectors.forEach(s=>coverageVisible?s.addTo(map):map.removeLayer(s)))}
function toggleTable(){document.getElementById('node-section').classList.toggle('hidden')}
function backToMenu(){location.href='index.html'}

showAll();
</script>
</body>
</html>
