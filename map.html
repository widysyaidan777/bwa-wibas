<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#020617;color:white}
header{
  height:60px;display:flex;align-items:center;
  padding:0 20px;font-size:22px;font-weight:bold;
  background:linear-gradient(90deg,#0f172a,#020617)
}
#sidebar{
  position:fixed;top:60px;left:0;width:220px;
  height:calc(100vh - 60px);background:#020617;padding:12px
}
button{
  width:100%;margin:6px 0;padding:8px;border:none;
  border-radius:4px;color:white;cursor:pointer
}
.blue{background:#2563eb}
.red{background:#dc2626}
#main{margin-left:220px;height:calc(100vh - 60px);display:flex;flex-direction:column}
#map{flex:1}

/* BLINK NODE */
@keyframes blinkGreen{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
@keyframes blinkRed{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}

.node-up{animation:blinkGreen 1s infinite}
.node-down{animation:blinkRed .7s infinite}

/* RULER LABEL */
.ruler-label{
  background:#020617;color:#facc15;
  border:1px solid #facc15;padding:4px 8px;
  border-radius:4px;font-size:12px
}
</style>
</head>

<body>
<header>Peta Topologi – BWA WiBAS</header>

<div id="sidebar">
  <h4>Ruler</h4>
  <button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
  <button class="red" onclick="resetRuler()">Reset Ruler</button>
</div>

<div id="main">
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* MAP */
const map=L.map('map').setView([-7.5,112],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ================= RULER DRAGGABLE ================= */
let rulerActive=false;
let p1=null,p2=null,line=null,label=null;

function activateRuler(){
  rulerActive=true;
  resetRuler();
  map.once('click',e=>{
    p1=createPoint(e.latlng);
    map.once('click',e2=>{
      p2=createPoint(e2.latlng);
      drawLine();
    });
  });
}

function createPoint(latlng){
  return L.marker(latlng,{draggable:true})
    .addTo(map)
    .on('drag',drawLine);
}

function drawLine(){
  if(!p1||!p2) return;
  const pts=[p1.getLatLng(),p2.getLatLng()];
  if(line) map.removeLayer(line);
  line=L.polyline(pts,{color:'#facc15',weight:3}).addTo(map);

  const d=(map.distance(pts[0],pts[1])/1000).toFixed(2);
  const mid=L.latLng(
    (pts[0].lat+pts[1].lat)/2,
    (pts[0].lng+pts[1].lng)/2
  );
  if(label) map.removeLayer(label);
  label=L.tooltip({permanent:true,className:'ruler-label'})
    .setLatLng(mid)
    .setContent(`<b>${d} km</b>`)
    .addTo(map);
}

function resetRuler(){
  [p1,p2,line,label].forEach(x=>x&&map.removeLayer(x));
  p1=p2=line=label=null;
}

/* ================= ICON ================= */
function nodeIcon(status,scale=1){
  const color=status==='UP'?'#14532d':'#7f1d1d';
  const cls=status==='UP'?'node-up':'node-down';
  const size=32*scale;
  return L.divIcon({
    className:cls,
    iconSize:[size,size],
    iconAnchor:[size/2,size/2],
    html:`<svg width="100%" height="100%" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="40" fill="${color}" stroke="white" stroke-width="4"/>
    </svg>`
  });
}

/* ================= COVERAGE ================= */
function createSector(c,r,s,e,col){
  const pts=[c];
  for(let a=s;a<=e;a+=5){
    const rad=a*Math.PI/180;
    pts.push(L.latLng(
      c.lat+(r*Math.sin(rad))/111320,
      c.lng+(r*Math.cos(rad))/(111320*Math.cos(c.lat*Math.PI/180))
    ));
  }
  pts.push(c);
  return L.polygon(pts,{color:col,fillColor:col,fillOpacity:.3,weight:1});
}

/* ================= DATA (20 CONTOH NODE) ================= */
const nodes=[
 {name:'N01',lat:-6.9,lng:107.6,status:'UP'},
 {name:'N02',lat:-7.0,lng:107.7,status:'DOWN'},
 {name:'N03',lat:-7.1,lng:107.8,status:'UP'},
 {name:'N04',lat:-7.2,lng:107.9,status:'DOWN'},
 {name:'N05',lat:-7.3,lng:108.0,status:'UP'},
 {name:'N06',lat:-7.4,lng:108.1,status:'DOWN'},
 {name:'N07',lat:-7.5,lng:108.2,status:'UP'},
 {name:'N08',lat:-7.6,lng:108.3,status:'DOWN'},
 {name:'N09',lat:-7.7,lng:108.4,status:'UP'},
 {name:'N10',lat:-7.8,lng:108.5,status:'DOWN'},
 {name:'N11',lat:-8.0,lng:110.3,status:'UP'},
 {name:'N12',lat:-8.1,lng:110.4,status:'DOWN'},
 {name:'N13',lat:-8.2,lng:110.5,status:'UP'},
 {name:'N14',lat:-8.3,lng:110.6,status:'DOWN'},
 {name:'N15',lat:-8.4,lng:110.7,status:'UP'},
 {name:'N16',lat:-8.5,lng:110.8,status:'DOWN'},
 {name:'N17',lat:-8.6,lng:110.9,status:'UP'},
 {name:'N18',lat:-8.7,lng:111.0,status:'DOWN'},
 {name:'N19',lat:-8.8,lng:111.1,status:'UP'},
 {name:'N20',lat:-8.9,lng:111.2,status:'DOWN'}
];

const sectorColors=['#dc2626','#facc15','#22c55e','#2563eb'];

/* ================= CREATE NODE ================= */
nodes.forEach(n=>{
  n.marker=L.marker([n.lat,n.lng],{icon:nodeIcon(n.status)})
    .addTo(map)
    .bindPopup(`<b>${n.name}</b><br>Status: ${n.status}`);

  for(let i=0;i<4;i++){
    createSector(
      L.latLng(n.lat,n.lng),
      5000,
      i*90,(i+1)*90,
      sectorColors[i]
    ).addTo(map);
  }
});

/* ================= ZOOM ICON SCALE ================= */
map.on('zoomend',()=>{
  const z=map.getZoom();
  const scale=Math.max(1,z/7);
  nodes.forEach(n=>{
    n.marker.setIcon(nodeIcon(n.status,scale));
  });
});
</script>
</body>
</html>
