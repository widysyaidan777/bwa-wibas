<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#0f172a; }

header {
  height:64px;
  background:linear-gradient(90deg,#0f172a,#020617);
  color:#fff;
  padding:16px;
  display:flex;
  align-items:center;
}

/* ===== SIDEBAR ===== */
#sidebar {
  position:fixed;
  top:64px; left:0;
  width:260px;
  height:calc(100vh - 64px);
  background:#1e293b;
  color:white;
  padding:12px;
  box-sizing:border-box;
  overflow-y:auto;
  z-index:1000;
}

#map {
  margin-left:260px;
  height:calc(100vh - 64px);
}

/* ===== NODE MENU ===== */
.menu-title {
  font-size:18px;
  margin:10px 0;
}

.menu-btn {
  width:100%;
  padding:10px;
  margin-bottom:6px;
  background:#3b82f6;
  border:none;
  border-radius:4px;
  color:white;
  cursor:pointer;
  text-align:left;
}
.menu-btn:hover { background:#2563eb; }

.area-btn {
  background:#334155;
  font-weight:bold;
}

.sub-menu {
  margin-left:12px;
  display:none;
}

.sub-menu button {
  background:#475569;
}

.status-up { animation:blinkBlue 1s infinite; }
.status-down { animation:blinkRed 1s infinite; }

@keyframes blinkBlue { 50%{opacity:.3;} }
@keyframes blinkRed { 50%{opacity:.3;} }
</style>
</head>

<body>

<header>
  <h2>Peta Topologi – BWA WiBAS</h2>
</header>

<!-- ===== SIDEBAR ===== -->
<div id="sidebar">
  <div class="menu-title">Daftar Node</div>

  <button class="menu-btn" onclick="showAllNodes()">All</button>

  <!-- CJDA -->
  <button class="menu-btn area-btn" onclick="toggleArea('CJDA')">
    CJDA (Central Java & DIY Area)
  </button>
  <div class="sub-menu" id="CJDA"></div>

  <!-- WKA -->
  <button class="menu-btn area-btn" onclick="toggleArea('WKA')">
    WKA
  </button>
  <div class="sub-menu" id="WKA"></div>

  <hr style="border:1px solid #334155;margin:12px 0">

  <div class="menu-title">Ruler Coverage</div>
  <button class="menu-btn" onclick="enableRuler()">Aktifkan Ruler</button>
  <button class="menu-btn" style="background:#ef4444" onclick="resetRuler()">
    Reset Ruler
  </button>
  <div id="ruler-info" style="font-size:13px">Klik 2 titik</div>
</div>

<!-- ===== MAP ===== -->
<div id="map"></div>

<script>
/* ===== MAP ===== */
const map = L.map('map').setView([-6.9,110.4],7);
L.tileLayer(
 'https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=fI3LpQe8kMXj5ntFo68C',
 { attribution:'© MapTiler © OpenStreetMap' }
).addTo(map);

/* ===== SECTOR ===== */
function destinationPoint(lat,lng,bearing,dist){
 const R=6378137;
 const br=bearing*Math.PI/180;
 const lat1=lat*Math.PI/180;
 const lon1=lng*Math.PI/180;
 const lat2=Math.asin(
  Math.sin(lat1)*Math.cos(dist/R)+
  Math.cos(lat1)*Math.sin(dist/R)*Math.cos(br)
 );
 const lon2=lon1+Math.atan2(
  Math.sin(br)*Math.sin(dist/R)*Math.cos(lat1),
  Math.cos(dist/R)-Math.sin(lat1)*Math.sin(lat2)
 );
 return [lat2*180/Math.PI, lon2*180/Math.PI];
}

function drawSector(c,s,e,r,color){
 const pts=[c];
 for(let a=s;a<=e;a+=2) pts.push(destinationPoint(c[0],c[1],a,r));
 return L.polygon(pts,{color,fillColor:color,fillOpacity:.35});
}

/* ===== NODE DATA ===== */
const nodes={};

const nodeData = {
  CJDA: [
    {name:'Node 1', coord:[-7.005,110.438]},
    {name:'Node 2', coord:[-7.797,110.370]},
    {name:'Node 3', coord:[-6.966,110.420]}
  ],
  WKA: [
    {name:'Node 2', coord:[-6.208,106.845]},
    {name:'Node 3', coord:[-6.300,106.800]},
    {name:'Node 4', coord:[-6.150,106.500]}
  ]
};

function createNode(name,center){
 const status=Math.random()>0.5?'up':'down';
 const color=status==='up'?'blue':'red';
 const blink=status==='up'?'status-up':'status-down';
 const r=5000;

 const layers=[
  drawSector(center,0,360,r,color),
  L.circleMarker(center,{
    radius:9,color,fillColor:color,fillOpacity:1,className:blink
  }).bindPopup(`<b>${name}</b><br>Status: ${status.toUpperCase()}`)
 ];
 nodes[name]={layers,center};
}

/* ===== BUILD MENU ===== */
Object.entries(nodeData).forEach(([area,list])=>{
 const container=document.getElementById(area);
 list.forEach(n=>{
  createNode(n.name,n.coord);
  const btn=document.createElement('button');
  btn.className='menu-btn';
  btn.innerText=n.name;
  btn.onclick=()=>showNode(n.name);
  container.appendChild(btn);
 });
});

/* ===== ACTION ===== */
function clearMap(){
 Object.values(nodes).forEach(n=>n.layers.forEach(l=>map.removeLayer(l)));
}

function showNode(name){
 clearMap();
 nodes[name].layers.forEach(l=>l.addTo(map));
 map.flyTo(nodes[name].center,12);
}

function showAllNodes(){
 clearMap();
 Object.values(nodes).forEach(n=>n.layers.forEach(l=>l.addTo(map)));
}

function toggleArea(id){
 const el=document.getElementById(id);
 el.style.display = el.style.display==='block'?'none':'block';
}

showAllNodes();

/* ===== RULER ===== */
let rulerActive=false, markers=[], line=null;
const info=document.getElementById('ruler-info');

function enableRuler(){
 resetRuler(); rulerActive=true; info.innerText='Klik 2 titik';
}

function resetRuler(){
 rulerActive=false;
 markers.forEach(m=>map.removeLayer(m));
 if(line) map.removeLayer(line);
 markers=[]; line=null; info.innerText='Klik 2 titik';
}

map.on('click',e=>{
 if(!rulerActive||markers.length>=2) return;
 const m=L.marker(e.latlng,{draggable:true}).addTo(map);
 markers.push(m);
 if(markers.length===2){
  rulerActive=false;
  line=L.polyline(markers.map(m=>m.getLatLng()),
   {color:'yellow',dashArray:'6,6'}).addTo(map);
 }
});
</script>

</body>
</html>
