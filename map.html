<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Map + Ruler Distance & Azimuth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 100vh; }

  .map-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
    cursor: pointer;
    font-weight: bold;
  }

  .map-btn.active {
    background: #2563eb;
    color: white;
  }
</style>
</head>

<body>

<div class="map-btn" id="rulerBtn">üìè Ruler</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([-6.2, 106.8], 9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

/* ================= RULER ================= */
let rulerActive = false;
let startPoint = null;
let tempLine = null;

const rulerBtn = document.getElementById('rulerBtn');

rulerBtn.onclick = () => {
  rulerActive = !rulerActive;
  startPoint = null;

  if (tempLine) {
    map.removeLayer(tempLine);
    tempLine = null;
  }

  rulerBtn.classList.toggle('active', rulerActive);
};

/* ================= HELPER ================= */
function calculateAzimuth(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const toDeg = rad => rad * 180 / Math.PI;

  const dLon = toRad(lon2 - lon1);
  lat1 = toRad(lat1);
  lat2 = toRad(lat2);

  const y = Math.sin(dLon) * Math.cos(lat2);
  const x = Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

  let brng = toDeg(Math.atan2(y, x));
  return (brng + 360) % 360;
}

/* ================= CLICK EVENT ================= */
map.on('click', e => {
  if (!rulerActive) return;

  if (!startPoint) {
    startPoint = e.latlng;
    L.marker(startPoint).addTo(map)
      .bindPopup("Titik Awal")
      .openPopup();
  } else {
    const endPoint = e.latlng;

    if (tempLine) map.removeLayer(tempLine);

    tempLine = L.polyline([startPoint, endPoint], {
      color: 'red',
      weight: 3
    }).addTo(map);

    const distance = startPoint.distanceTo(endPoint); // meter
    const azimuth = calculateAzimuth(
      startPoint.lat, startPoint.lng,
      endPoint.lat, endPoint.lng
    );

    const popupText = `
      <b>Ruler Measurement</b><br>
      üìè Distance : ${(distance/1000).toFixed(2)} km<br>
      üß≠ Azimuth : ${azimuth.toFixed(2)}¬∞
    `;

    L.marker(endPoint).addTo(map)
      .bindPopup(popupText)
      .openPopup();

    // reset agar bisa ukur ulang
    startPoint = null;
    rulerActive = false;
    rulerBtn.classList.remove('active');
  }
});
</script>

</body>
</html>
