<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Topologi – BWA WiBAS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;font-family:Arial;background:#020617;color:white
}
header{
  height:60px;display:flex;align-items:center;
  padding:0 20px;
  background:linear-gradient(90deg,#0f172a,#020617);
  font-size:22px;font-weight:bold
}
#sidebar{
  position:fixed;top:60px;left:0;width:220px;
  height:calc(100vh - 60px);
  background:#020617;padding:12px
}
button{
  width:100%;margin:6px 0;padding:8px;
  border:none;border-radius:4px;color:white;cursor:pointer
}
.blue{background:#2563eb}
.gray{background:#334155}
.red{background:#dc2626}

#main{
  margin-left:220px;
  height:calc(100vh - 60px);
  display:flex;flex-direction:column
}
#map{flex:1}

#toggle{
  text-align:center;padding:6px;
  background:#020617;border-top:1px solid #334155;cursor:pointer
}
#node-section{
  max-height:260px;overflow:auto;background:#1e293b;transition:.3s
}
#node-section.hidden{max-height:0}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border-bottom:1px solid #334155}
th{background:#020617}
.up{color:#22c55e}
.down{color:#ef4444}

@keyframes blink{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
.node-blink{animation:blink 1s infinite}
.node-blink.fast{animation:blink .4s infinite}

.ruler-label{
  background:#020617;
  color:#facc15;
  border:1px solid #facc15;
  padding:6px 10px;
  border-radius:4px;
  font-size:12px;
}
</style>
</head>

<body>
<header>Peta Topologi – BWA WiBAS</header>

<div id="sidebar">
  <h4>Area</h4>
  <button class="blue" onclick="showAll()">All</button>
  <button class="gray" onclick="filterRegion('CJDA')">CJDA</button>
  <button class="gray" onclick="filterRegion('WKA')">WKA</button>
  <button class="gray" onclick="filterRegion('BNA')">BNA</button>

  <hr style="border:1px solid #334155">

  <h4>Ruler</h4>
  <button class="blue" onclick="activateRuler()">Aktifkan Ruler</button>
  <button class="red" onclick="resetRuler()">Reset Ruler</button>

  <hr style="border:1px solid #334155">
  <button class="gray" onclick="toggleCoverage()">Toggle Coverage</button>
</div>

<div id="main">
  <div id="map"></div>
  <div id="toggle" onclick="toggleTable()">▲ / ▼</div>
  <div id="node-section">
    <table>
      <thead><tr><th>Node</th><th>Area</th><th>Status</th></tr></thead>
      <tbody id="node-table"></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([-6.9,110.5],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ================= RULER DRAG + AZIMUTH ================= */
let rulerActive=false;
let rA=null,rB=null,rLine=null,rLabel=null;

function toRad(d){return d*Math.PI/180}
function toDeg(r){return (r*180/Math.PI+360)%360}

function bearing(a,b){
 const φ1=toRad(a.lat), φ2=toRad(b.lat);
 const Δλ=toRad(b.lng-a.lng);
 return toDeg(Math.atan2(
  Math.sin(Δλ)*Math.cos(φ2),
  Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ)
 ));
}

function updateRuler(){
 if(!rA||!rB) return;
 const p1=rA.getLatLng(), p2=rB.getLatLng();
 if(rLine) map.removeLayer(rLine);
 rLine=L.polyline([p1,p2],{color:'#facc15',weight:3}).addTo(map);
 const d=(map.distance(p1,p2)/1000).toFixed(2);
 const az=bearing(p1,p2).toFixed(1);
 if(rLabel) map.removeLayer(rLabel);
 rLabel=L.tooltip({permanent:true,className:'ruler-label'})
  .setLatLng(L.latLng((p1.lat+p2.lat)/2,(p1.lng+p2.lng)/2))
  .setContent(`<b>${d} km</b><br>Azimuth: ${az}°`)
  .addTo(map);
}

function activateRuler(){
 resetRuler(); rulerActive=true;
 map.getContainer().style.cursor='crosshair';
}
function resetRuler(){
 rulerActive=false;
 [rA,rB,rLine,rLabel].forEach(x=>x&&map.removeLayer(x));
 rA=rB=rLine=rLabel=null;
 map.getContainer().style.cursor='';
}

map.on('click',e=>{
 if(!rulerActive) return;
 if(!rA){
  rA=L.marker(e.latlng,{draggable:true}).addTo(map).on('drag',updateRuler);
 }else if(!rB){
  rB=L.marker(e.latlng,{draggable:true}).addTo(map).on('drag',updateRuler);
  updateRuler(); rulerActive=false;
 }
});

/* ================= NODE ICON ================= */
function icon(colors,fast){
 return L.divIcon({
  className:`node-blink ${fast?'fast':''}`,
  iconSize:[36,36],iconAnchor:[18,18],
  html:`<svg viewBox="0 0 100 100">
<path d="M50 50 L50 0 A50 50 0 0 1 100 50 Z" fill="${colors[0]}"/>
<path d="M50 50 L100 50 A50 50 0 0 1 50 100 Z" fill="${colors[1]}"/>
<path d="M50 50 L50 100 A50 50 0 0 1 0 50 Z" fill="${colors[2]}"/>
<path d="M50 50 L0 50 A50 50 0 0 1 50 0 Z" fill="${colors[3]}"/>
<circle cx="50" cy="50" r="9" fill="#020617" stroke="white" stroke-width="2"/>
</svg>`
 });
}

/* ================= NODE DATA (CONTOH) ================= */
const nodes=[
 {name:'SOLO',region:'CJDA',lat:-7.5666,lng:110.8166,status:'UP'},
 {name:'YOGYA',region:'CJDA',lat:-7.7956,lng:110.3695,status:'UP'},
 {name:'BALIKPAPAN',region:'WKA',lat:-1.2479,lng:116.8382,status:'DOWN'},
 {name:'SAMARINDA',region:'WKA',lat:-0.5021,lng:117.1537,status:'UP'},
 {name:'DENPASAR',region:'BNA',lat:-8.65,lng:115.2167,status:'UP'}
];

let coverageVisible=true;

/* ================= CREATE NODE ================= */
nodes.forEach(n=>{
 const col=n.status==='UP'
 ?['#2563eb','#22c55e','#2563eb','#22c55e']
 :['#dc2626','#f97316','#dc2626','#f97316'];

 n.marker=L.marker([n.lat,n.lng],{icon:icon(col,n.status==='DOWN')})
 .addTo(map)
 .bindPopup(`<b>${n.name}</b><br>Area: ${n.region}<br>Status: ${n.status}`);

 n.marker.on('click',e=>{
  if(rulerActive){map.fire('click',{latlng:e.latlng});L.DomEvent.stop(e);}
 });

 n.sectors=[];
 for(let i=0;i<4;i++){
  n.sectors.push(
   L.circle([n.lat,n.lng],{radius:5000,color:col[i],fillOpacity:.2})
   .addTo(map)
  );
 }
});

/* ================= TABLE + FILTER ================= */
function render(list){
 const tb=document.getElementById('node-table');tb.innerHTML='';
 list.forEach(n=>{
  tb.innerHTML+=`
<tr onclick="focusNode('${n.name}')">
<td>${n.name}</td><td>${n.region}</td>
<td class="${n.status==='UP'?'up':'down'}">${n.status}</td></tr>`;
 });
}
function focusNode(name){
 const n=nodes.find(x=>x.name===name);
 map.flyTo([n.lat,n.lng],10);n.marker.openPopup();
}
function showAll(){
 render(nodes);
 nodes.forEach(n=>{n.marker.addTo(map);n.sectors.forEach(s=>coverageVisible&&s.addTo(map))});
}
function filterRegion(r){
 render(nodes.filter(n=>n.region===r));
 nodes.forEach(n=>{
  n.region===r?n.marker.addTo(map):map.removeLayer(n.marker);
 });
}
function toggleCoverage(){
 coverageVisible=!coverageVisible;
 nodes.forEach(n=>n.sectors.forEach(s=>coverageVisible?s.addTo(map):map.removeLayer(s)));
}
function toggleTable(){
 document.getElementById('node-section').classList.toggle('hidden');
}

showAll();
</script>
</body>
</html>
